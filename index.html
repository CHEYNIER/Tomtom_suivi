<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Suivi TomTom PWA</title>
    <!-- Importation des biblioth√®ques n√©cessaires pour React, ReactDOM, Tailwind et Recharts -->
    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>

    <!-- Configuration Firebase et CSS Tailwind -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, query, onSnapshot, addDoc };
        window.recharts = { 
            LineChart: Recharts.LineChart, 
            Line: Recharts.Line, 
            XAxis: Recharts.XAxis, 
            YAxis: Recharts.YAxis, 
            CartesianGrid: Recharts.CartesianGrid, 
            Tooltip: Recharts.Tooltip, 
            Legend: Recharts.Legend, 
            ResponsiveContainer: Recharts.ResponsiveContainer 
        };
    </script>
    
    <style>
        /* Styles CSS pour am√©liorer l'exp√©rience PWA */
        body { margin: 0; padding: 0; background-color: #f8f9fa; }
        /* Pour s'assurer que l'app utilise tout l'√©cran */
        #root { min-height: 100vh; } 
    </style>
</head>
<body>
    <div id="root">
        <!-- L'application React sera rendue ici -->
        <div class="flex items-center justify-center min-h-screen bg-gray-100">
            <p class="text-xl text-gray-700">Chargement de l'application...</p>
        </div>
    </div>

    <!-- Le code JavaScript de l'application (JSX) -->
    <script type="text/babel">
        // Ceci est le contenu de votre ancien fichier TomTomActivityTracker.jsx, adapt√©
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.recharts;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, query, onSnapshot, addDoc } = window.firebase;
        
        // --- CONFIGURATION DE BASE DE FIREBASE (Utilisation des variables globales obligatoires) ---
        // Les variables globales du Canvas (__app_id, __firebase_config, __initial_auth_token) sont ici simul√©es car Vercel est un environnement externe.
        // NOTE: Si vous ex√©cutez ceci dans l'Immersive, les vraies variables seront disponibles.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tomtom-tracker-pwa-001'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialisation des instances Firebase (avec v√©rification)
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;

        // Styles Tailwind personnalis√©s
        const COLORS = {
          blue: '#0070a8',
          orange: '#ff6600',
          bg: '#f8f9fa',
        };

        // --- Composant Principal de l'Application ---
        const App = () => {
          const [activities, setActivities] = useState([]);
          const [loading, setLoading] = useState(true);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [userId, setUserId] = useState(null);
          const [error, setError] = useState(null);

          // 1. Initialisation et Authentification Firebase
          useEffect(() => {
            if (!auth || !db) {
                setError("La configuration Firebase est manquante. L'application ne peut pas stocker les donn√©es. Assurez-vous d'avoir configur√© Firebase pour ce projet.");
                setLoading(false);
                return;
            }

            // Fonction d'authentification
            const handleAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Pour une PWA gratuite sur Vercel, nous utilisons toujours l'anonyme si pas de token
                        await signInAnonymously(auth); 
                    }
                } catch (e) {
                    console.error("Erreur d'authentification:", e);
                    setError("√âchec de la connexion. V√©rifiez la configuration Firebase.");
                }
            };

            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    if (!userId) {
                        handleAuth();
                    } else {
                        setUserId(null); 
                    }
                }
                setIsAuthReady(true);
                setLoading(false);
            });

            return () => unsubscribe(); 
          }, [auth, db, initialAuthToken, userId]);

          // 2. R√©cup√©ration des donn√©es d'activit√© en temps r√©el
          useEffect(() => {
            if (!isAuthReady || !userId || !db) return;

            // Chemin Firestore pour les donn√©es priv√©es de l'utilisateur
            const activitiesPath = `artifacts/${appId}/users/${userId}/activities`;
            const q = query(collection(db, activitiesPath)); 

            const unsubscribe = onSnapshot(q, (snapshot) => {
              const fetchedActivities = [];
              snapshot.forEach((doc) => {
                fetchedActivities.push({ id: doc.id, ...doc.data() });
              });
              // Tri manuel par date la plus r√©cente
              fetchedActivities.sort((a, b) => b.date.toDate().getTime() - a.date.toDate().getTime()); 
              setActivities(fetchedActivities);
            }, (e) => {
                console.error("Erreur de r√©cup√©ration Firestore:", e);
                setError("Impossible de charger les activit√©s. Probl√®me de connexion ou de permissions.");
            });

            return () => unsubscribe();
          }, [isAuthReady, userId, db]); 

          // --- Fonctions M√©tiers ---

          // Ajout manuel d'une activit√©
          const addActivity = async (data) => {
            if (!userId || !db) {
                alert("Veuillez vous authentifier pour ajouter des activit√©s.");
                return;
            }
            setLoading(true);
            const activityData = {
                ...data,
                date: new Date(), 
                userId: userId
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/activities`), activityData);
                // Utilisation d'une bo√Æte de message personnalis√©e au lieu d'alert()
                showMessage("Activit√© enregistr√©e avec succ√®s !", "success");
            } catch (e) {
                console.error("Erreur lors de l'ajout de l'activit√©:", e);
                showMessage("√âchec de l'enregistrement de l'activit√©.", "error");
            } finally {
                setLoading(false);
            }
          };

          // Fonction pour afficher des messages (remplace alert())
          const showMessage = (message, type = 'info') => {
                // Vous pouvez impl√©menter un composant modal ou toast ici pour un meilleur UI
                console.log(`MESSAGE (${type.toUpperCase()}): ${message}`); 
                alert(message); // On utilise alert en dernier recours si pas de composant UI
          }


          // Pr√©paration des donn√©es pour le graphique (distance quotidienne)
          const getChartData = () => {
            const dailyData = {};
            activities.forEach(activity => {
                const dateKey = new Date(activity.date.toDate()).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                dailyData[dateKey] = (dailyData[dateKey] || 0) + activity.distance;
            });

            // On prend les 7 derni√®res dates, puis on les met dans l'ordre chronologique
            return Object.keys(dailyData).sort((a, b) => {
                const dateA = new Date(a.replace(/(\d+)\s+([a-z]+)/i, '$2 $1')).getTime();
                const dateB = new Date(b.replace(/(\d+)\s+([a-z]+)/i, '$2 $1')).getTime();
                return dateA - dateB;
            }).slice(-7).map(date => ({
                name: date,
                Distance: dailyData[date]
            }));
          };

          // Rendu
          if (loading && !userId && !error) {
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <p className="text-xl text-gray-700">Connexion √† la base de donn√©es...</p>
                </div>
            );
          }

          return (
            <div className={`p-4 sm:p-6 bg-gray-50 min-h-screen font-sans`}>
              <div className="max-w-4xl mx-auto">
                <header className="text-center mb-8">
                    <h1 className="text-3xl font-extrabold text-blue-800 flex items-center justify-center">
                        <span className="text-orange-500">MON</span> SUIVI SPORTIF PWA
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Application Web Progressive pour le suivi (ID: 
                        <span className="font-mono text-xs text-red-500 break-all">{userId || 'Non Authentifi√©'}</span>
                    </p>
                    {error && <p className="mt-2 text-sm text-red-600 font-medium p-2 bg-red-100 rounded-lg">{error}</p>}
                </header>

                {/* Formulaire d'Ajout (Simule l'importation de fichier) */}
                <ActivityForm onSubmit={addActivity} loading={loading} />

                {/* Section Graphique de Tendance */}
                <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-blue-500">
                    <h2 className="text-xl font-semibold mb-4 text-gray-700">Distance Quotidienne (7 derniers jours)</h2>
                    <div style={{ width: '100%', height: 300 }}>
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={getChartData()} margin={{ top: 5, right: 20, left: -20, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                <XAxis dataKey="name" stroke={COLORS.blue} />
                                <YAxis stroke={COLORS.blue} label={{ value: 'Distance (km)', angle: -90, position: 'insideLeft', fill: COLORS.blue }} />
                                <Tooltip contentStyle={{ backgroundColor: 'white', border: `1px solid ${COLORS.blue}`, borderRadius: '8px' }} />
                                <Legend wrapperStyle={{ paddingTop: '10px' }} />
                                <Line type="monotone" dataKey="Distance" stroke={COLORS.orange} strokeWidth={3} dot={{ stroke: COLORS.orange, strokeWidth: 2 }} activeDot={{ r: 8 }} />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Liste des Activit√©s */}
                <ActivityList activities={activities} />

              </div>
            </div>
          );
        };

        // --- Composant Formulaire d'Activit√© ---
        const ActivityForm = ({ onSubmit, loading }) => {
            const [type, setType] = useState('Course');
            const [distance, setDistance] = useState('');
            const [duration, setDuration] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const dist = parseFloat(distance);
                if (isNaN(dist) || dist <= 0 || !type || !duration) {
                    alert("Veuillez remplir tous les champs correctement.");
                    return;
                }

                onSubmit({
                    type,
                    distance: dist,
                    duration: duration,
                    avgHeartRate: Math.floor(70 + Math.random() * 50), 
                    maxSpeed: (dist / (parseInt(duration.split(':')[0]) + parseInt(duration.split(':')[1]) / 60) * 60).toFixed(1) || 0
                });

                setDistance('');
                setDuration('');
            };

            return (
                <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-orange-500">
                    <h2 className="text-xl font-semibold mb-4 text-gray-700">Enregistrer une Nouvelle Activit√© (Manuelle)</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <select 
                            value={type} 
                            onChange={(e) => setType(e.target.value)}
                            className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            disabled={loading}
                        >
                            <option value="Course">Course üèÉ</option>
                            <option value="V√©lo">V√©lo üö¥</option>
                            <option value="Natation">Natation üèä</option>
                            <option value="Randonn√©e">Randonn√©e üö∂</option>
                        </select>
                        <input
                            type="number"
                            step="0.1"
                            placeholder="Distance (km)"
                            value={distance}
                            onChange={(e) => setDistance(e.target.value)}
                            className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            disabled={loading}
                            required
                        />
                        <input
                            type="text"
                            placeholder="Dur√©e (h:min)"
                            value={duration}
                            onChange={(e) => setDuration(e.target.value)}
                            className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            disabled={loading}
                            required
                        />
                        <button
                            type="submit"
                            className={`col-span-1 p-3 text-white font-bold rounded-lg shadow-md transition ${loading ? 'bg-gray-400' : 'bg-orange-500 hover:bg-orange-600'}`}
                            disabled={loading}
                        >
                            {loading ? 'Sauvegarde...' : 'Ajouter l\'Activit√©'}
                        </button>
                    </div>
                </form>
            );
        };

        // --- Composant Liste des Activit√©s ---
        const ActivityList = ({ activities }) => (
            <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 className="text-xl font-semibold mb-4 text-gray-700">Historique des Activit√©s ({activities.length})</h2>
                <ul className="space-y-3">
                    {activities.length === 0 ? (
                        <p className="text-gray-500 italic">Aucune activit√© enregistr√©e.</p>
                    ) : (
                        activities.map(activity => (
                            <li key={activity.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150 border-l-4 border-orange-400">
                                <div className="flex items-center">
                                    <span className="text-xl mr-3">{activity.type === 'Course' ? 'üèÉ' : activity.type === 'V√©lo' ? 'üö¥' : activity.type === 'Natation' ? 'üèä' : 'üö∂'}</span>
                                    <div>
                                        <p className="font-semibold text-gray-800">{activity.type} - {new Date(activity.date.toDate()).toLocaleDateString('fr-FR')}</p>
                                        <p className="text-sm text-gray-500">
                                            {activity.distance.toFixed(2)} km | {activity.duration} | FC Moy: {activity.avgHeartRate} BPM
                                        </p>
                                    </div>
                                </div>
                                <span className="text-blue-500 font-medium text-sm">V. Max: {activity.maxSpeed} km/h</span>
                            </li>
                        ))
                    )}
                </ul>
            </div>
        );
        
        // Rendu final
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDilpknYSeSj2-4Q1xsFc4NfehZXxEnPnQ",
  authDomain: "tomtom-connect.firebaseapp.com",
  projectId: "tomtom-connect",
  storageBucket: "tomtom-connect.firebasestorage.app",
  messagingSenderId: "511599756901",
  appId: "1:511599756901:web:ad86f208e0dd561858288c",
  measurementId: "G-XQ9SL95199"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDilpknYSeSj2-4Q1xsFc4NfehZXxEnPnQ",
  authDomain: "tomtom-connect.firebaseapp.com",
  projectId: "tomtom-connect",
  storageBucket: "tomtom-connect.firebasestorage.app",
  messagingSenderId: "511599756901",
  appId: "1:511599756901:web:ad86f208e0dd561858288c",
  measurementId: "G-XQ9SL95199"
};// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDilpknYSeSj2-4Q1xsFc4NfehZXxEnPnQ",
  authDomain: "tomtom-connect.firebaseapp.com",
  projectId: "tomtom-connect",
  storageBucket: "tomtom-connect.firebasestorage.app",
  messagingSenderId: "511599756901",
  appId: "1:511599756901:web:ad86f208e0dd561858288c",
  measurementId: "G-XQ9SL95199"
};
