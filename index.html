<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Suivi TomTom PWA</title>
    <!-- 1. Importation des biblioth√®ques n√©cessaires (React doit √™tre charg√© en premier) -->
    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Recharts pour les graphiques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>

    <!-- 3. Configuration Firebase (chargement des modules via CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Active les logs de debug pour Firestore (utile pour le d√©buggage de connexion)
        setLogLevel('debug'); 

        // Rend les fonctions globales pour qu'elles soient accessibles par Babel/JSX
        window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, query, onSnapshot, addDoc, setLogLevel };
    </script>
    
    <style>
        /* Styles CSS pour am√©liorer l'exp√©rience PWA */
        body { margin: 0; padding: 0; background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        #root { min-height: 100vh; } 
    </style>
</head>
<body>
    <div id="root">
        <!-- L'application React sera rendue ici -->
        <div class="flex items-center justify-center min-h-screen bg-gray-100">
            <p class="text-xl text-gray-700">Chargement de l'application...</p>
        </div>
    </div>

    <!-- 4. Le code JavaScript de l'application (JSX) - Ex√©cut√© s√©quentiellement apr√®s les biblioth√®ques -->
    <script type="text/babel">
        // FIX CRITIQUE: R√©introduction de window.onload pour garantir que React et ReactDOM sont d√©finis 
        // avant que le code JSX ne tente de les utiliser et de d√©structurer React.
        window.onload = function() {
        
            // Les variables React et Recharts DOIVENT √™tre disponibles ici
            const { useState, useEffect } = React;
            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, query, onSnapshot, addDoc } = window.firebase;
            
            // --- CONFIGURATION FIREBASE (CLEAN) ---
            const FIREBASE_CONFIG = {
                apiKey: "AIzaSyDilpknYSeSj2-4Q1xsFc4NfehZXxEnPnQ",
                authDomain: "tomtom-connect.firebaseapp.com",
                projectId: "tomtom-connect",
                storageBucket: "tomtom-connect.firebasestorage.app",
                messagingSenderId: "511599756901",
                appId: "1:511599756901:web:ad86f208e0dd561858288c",
                measurementId: "G-XQ9SL95199"
            };
            
            const firebaseConfig = FIREBASE_CONFIG;
            const appId = FIREBASE_CONFIG.projectId; 

            // Initialisation des instances Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            // ---------------------------------------------


            // Styles Tailwind personnalis√©s
            const COLORS = {
                blue: '#0070a8',
                orange: '#ff6600',
                bg: '#f8f9fa',
            };
            
            // Composant Message Modal (pour remplacer alert())
            const MessageModal = ({ message, type, onClose }) => {
                if (!message) return null;

                const baseStyle = "fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-70 z-50 p-4";
                const cardStyle = `bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100`;
                let headerStyle = "text-xl font-bold mb-2";
                let buttonStyle = "mt-4 w-full p-3 rounded-lg text-white font-bold transition";

                if (type === 'error') {
                    headerStyle += " text-red-600";
                    buttonStyle += " bg-red-500 hover:bg-red-600";
                } else if (type === 'success') {
                    headerStyle += " text-green-600";
                    buttonStyle += " bg-green-500 hover:bg-green-600";
                } else {
                    headerStyle += " text-blue-600";
                    buttonStyle += " bg-blue-500 hover:bg-blue-600";
                }

                return (
                    <div className={baseStyle} onClick={onClose}>
                        <div className={cardStyle} onClick={(e) => e.stopPropagation()}>
                            <h3 className={headerStyle}>{type === 'error' ? 'Erreur' : type === 'success' ? 'Succ√®s' : 'Information'}</h3>
                            <p className="text-gray-700">{message}</p>
                            <button onClick={onClose} className={buttonStyle}>
                                Fermer
                            </button>
                        </div>
                    </div>
                );
            };

            // --- Composant Principal de l'Application ---
            const App = () => {
                const [activities, setActivities] = useState([]);
                const [loading, setLoading] = useState(true);
                const [isAuthReady, setIsAuthReady] = useState(false);
                const [userId, setUserId] = useState(null);
                const [error, setError] = useState(null);
                const [modal, setModal] = useState({ message: '', type: 'info' });

                // Remplacer alert() par le modal
                const showMessage = (message, type = 'info') => {
                    setModal({ message, type });
                }

                // 1. Initialisation et Authentification Firebase
                useEffect(() => {
                    // Si la config est vide, on affiche une erreur imm√©diatement
                    if (!db || !auth) {
                        setError("Erreur critique: La configuration Firebase a √©chou√©.");
                        setLoading(false);
                        return;
                    }

                    // Fonction d'authentification (anonyme pour PWA)
                    const handleAuth = async () => {
                        try {
                            // Utilisation de l'authentification anonyme pour connecter l'utilisateur
                            await signInAnonymously(auth);  
                        } catch (e) {
                            console.error("Erreur d'authentification:", e);
                            setError("√âchec de la connexion anonyme. V√©rifiez les r√®gles d'authentification Firebase.");
                        }
                    };

                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            // Si on est d√©connect√©, on tente de se connecter anonymement
                            if (!userId) {
                                 handleAuth();
                            } else {
                                setUserId(null); 
                            }
                        }
                        setIsAuthReady(true);
                        setLoading(false);
                    });

                    return () => unsubscribe(); 
                }, []); 

                // 2. R√©cup√©ration des donn√©es d'activit√© en temps r√©el
                useEffect(() => {
                    if (!isAuthReady || !userId) return; // Attend que l'auth soit pr√™te

                    // Chemin Firestore pour les donn√©es priv√©es de l'utilisateur
                    const activitiesPath = `artifacts/${appId}/users/${userId}/activities`;
                    const q = query(collection(db, activitiesPath)); 

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedActivities = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            // V√©rifie si la date est un Timestamp Firestore et la convertit
                            const dateValue = data.date && typeof data.date.toDate === 'function' ? data.date : { toDate: () => new Date() };

                            fetchedActivities.push({ 
                                id: doc.id, 
                                ...data,
                                date: dateValue 
                            });
                        });
                        
                        // Tri manuel par date la plus r√©cente
                        fetchedActivities.sort((a, b) => b.date.toDate().getTime() - a.date.toDate().getTime()); 
                        setActivities(fetchedActivities);
                    }, (e) => {
                        console.error("Erreur de r√©cup√©ration Firestore:", e);
                        setError("Impossible de charger les activit√©s. V√©rifiez vos r√®gles de s√©curit√© Firestore.");
                    });

                    return () => unsubscribe();
                }, [isAuthReady, userId, appId]); 

                // --- Fonctions M√©tiers ---

                // Ajout manuel d'une activit√©
                const addActivity = async (data) => {
                    if (!userId) {
                        showMessage("Veuillez patienter pour l'authentification.", "error");
                        return;
                    }
                    setLoading(true);
                    const activityData = {
                        ...data,
                        // Utilisation de l'objet Date natif pour laisser Firestore cr√©er le Timestamp
                        date: new Date(), 
                        userId: userId
                    };

                    try {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/activities`), activityData);
                        showMessage("Activit√© enregistr√©e avec succ√®s !", "success");
                    } catch (e) {
                        console.error("Erreur lors de l'ajout de l'activit√©:", e);
                        showMessage("√âchec de l'enregistrement de l'activit√©. V√©rifiez les permissions d'√©criture.", "error");
                    } finally {
                        setLoading(false);
                    }
                };

                // Pr√©paration des donn√©es pour le graphique (distance quotidienne)
                const getChartData = () => {
                    const dailyData = {};
                    activities.forEach(activity => {
                        const date = activity.date.toDate();
                        const dateKey = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                        dailyData[dateKey] = (dailyData[dateKey] || 0) + activity.distance;
                    });

                    // Tri par date pour s'assurer que les points sont dans l'ordre chronologique
                    const sortedKeys = Object.keys(dailyData).sort((a, b) => {
                        const parseDateKey = (key) => {
                            try {
                                const [day, monthStr] = key.split(' ');
                                const now = new Date();
                                const year = now.getFullYear();
                                return new Date(`${day} ${monthStr} ${year}`).getTime();
                            } catch (e) {
                                return 0;
                            }
                        };

                        return parseDateKey(a) - parseDateKey(b);
                    }).slice(-7); // Ne garde que les 7 plus r√©centes

                    return sortedKeys.map(date => ({
                        name: date,
                        Distance: dailyData[date]
                    }));
                };

                // Rendu
                if (loading && !isAuthReady) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-50">
                            <div className="flex flex-col items-center">
                                <svg className="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p className="text-xl text-gray-700 mt-3">Connexion √† la base de donn√©es...</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className={`p-4 sm:p-6 bg-gray-50 min-h-screen font-sans`}>
                        <div className="max-w-4xl mx-auto">
                            <header className="text-center mb-8">
                                <h1 className="text-3xl font-extrabold text-blue-800 flex flex-col items-center justify-center">
                                    <span className="text-orange-500">MON</span> SUIVI SPORTIF PWA
                                </h1>
                                <p className="text-gray-600 mt-1">
                                    Application Web Progressive (ID Utilisateur: 
                                    <span className="font-mono text-xs text-red-500 break-all ml-1">{userId || 'Non Authentifi√©'}</span>
                                </p>
                                {error && <p className="mt-2 text-sm text-red-600 font-medium p-2 bg-red-100 rounded-lg">{error}</p>}
                            </header>

                            {/* Formulaire d'Ajout */}
                            <ActivityForm onSubmit={addActivity} loading={loading} showMessage={showMessage} />

                            {/* Section Graphique de Tendance */}
                            <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-blue-500">
                                <h2 className="text-xl font-semibold mb-4 text-gray-700">Distance Quotidienne (7 derniers jours)</h2>
                                <div style={{ width: '100%', height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={getChartData()} margin={{ top: 5, right: 20, left: -20, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                            <XAxis dataKey="name" stroke={COLORS.blue} />
                                            <YAxis stroke={COLORS.blue} label={{ value: 'Distance (km)', angle: -90, position: 'insideLeft', fill: COLORS.blue }} />
                                            <Tooltip contentStyle={{ backgroundColor: 'white', border: `1px solid ${COLORS.blue}`, borderRadius: '8px' }} />
                                            <Legend wrapperStyle={{ paddingTop: '10px' }} />
                                            <Line type="monotone" dataKey="Distance" stroke={COLORS.orange} strokeWidth={3} dot={{ stroke: COLORS.orange, strokeWidth: 2 }} activeDot={{ r: 8 }} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Liste des Activit√©s */}
                            <ActivityList activities={activities} />

                        </div>
                        {/* Modal pour les messages (remplace alert) */}
                        <MessageModal 
                            message={modal.message} 
                            type={modal.type} 
                            onClose={() => setModal({ message: '', type: 'info' })}
                        />
                    </div>
                );
            };

            // --- Composant Formulaire d'Activit√© ---
            const ActivityForm = ({ onSubmit, loading, showMessage }) => {
                const [type, setType] = useState('Course');
                const [distance, setDistance] = useState('');
                const [duration, setDuration] = useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const dist = parseFloat(distance);
                    const durationParts = duration.split(':');
                    
                    if (isNaN(dist) || dist <= 0 || !type || durationParts.length !== 2 || durationParts.some(p => isNaN(parseInt(p)))) {
                        showMessage("Veuillez remplir tous les champs correctement (Distance > 0, Dur√©e format H:MM).", "error");
                        return;
                    }
                    
                    // Calcul simple de la vitesse max en km/h
                    const hours = parseInt(durationParts[0] || 0);
                    const minutes = parseInt(durationParts[1] || 0);
                    const totalHours = hours + (minutes / 60);

                    if (totalHours <= 0) {
                         showMessage("La dur√©e doit √™tre sup√©rieure √† z√©ro.", "error");
                         return;
                    }

                    const maxSpeed = (dist / totalHours);

                    onSubmit({
                        type,
                        distance: dist,
                        duration: duration,
                        // G√©n√®re une fr√©quence cardiaque moyenne al√©atoire pour simuler les donn√©es TomTom
                        avgHeartRate: Math.floor(70 + Math.random() * 50), 
                        maxSpeed: parseFloat(maxSpeed.toFixed(1))
                    });

                    setDistance('');
                    setDuration('');
                };

                return (
                    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-orange-500">
                        <h2 className="text-xl font-semibold mb-4 text-gray-700">Enregistrer une Nouvelle Activit√© (Manuelle)</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                            <select 
                                value={type} 
                                onChange={(e) => setType(e.target.value)}
                                className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                disabled={loading}
                            >
                                <option value="Course">Course üèÉ</option>
                                <option value="V√©lo">V√©lo üö¥</option>
                                <option value="Natation">Natation üèä</option>
                                <option value="Randonn√©e">Randonn√©e üö∂</option>
                            </select>
                            <input
                                type="number"
                                step="0.1"
                                placeholder="Distance (km)"
                                value={distance}
                                onChange={(e) => setDistance(e.target.value)}
                                className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                disabled={loading}
                                required
                            />
                            <input
                                type="text"
                                placeholder="Dur√©e (h:min - Ex: 1:30)"
                                value={duration}
                                onChange={(e) => setDuration(e.target.value)}
                                className="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                disabled={loading}
                                required
                            />
                            <button
                                type="submit"
                                className={`col-span-1 p-3 text-white font-bold rounded-lg shadow-md transition ${loading ? 'bg-gray-400' : 'bg-orange-500 hover:bg-orange-600'}`}
                                disabled={loading}
                            >
                                {loading ? 'Sauvegarde...' : 'Ajouter l\'Activit√©'}
                            </button>
                        </div>
                    </form>
                );
            };

            // --- Composant Liste des Activit√©s ---
            const ActivityList = ({ activities }) => (
                <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h2 className="text-xl font-semibold mb-4 text-gray-700">Historique des Activit√©s ({activities.length})</h2>
                    <ul className="space-y-3">
                        {activities.length === 0 ? (
                            <p className="text-gray-500 italic">Aucune activit√© enregistr√©e. Ajoutez-en une manuellement ci-dessus.</p>
                        ) : (
                            activities.map(activity => (
                                <li key={activity.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150 border-l-4 border-orange-400">
                                    <div className="flex items-center w-full sm:w-auto">
                                        <span className="text-xl mr-3 flex-shrink-0">
                                            {activity.type === 'Course' ? 'üèÉ' : activity.type === 'V√©lo' ? 'üö¥' : activity.type === 'Natation' ? 'üèä' : 'üö∂'}
                                        </span>
                                        <div className="flex-grow">
                                            <p className="font-semibold text-gray-800 text-base">{activity.type} - {activity.date.toDate().toLocaleDateString('fr-FR')}</p>
                                            <p className="text-sm text-gray-500">
                                                {activity.distance.toFixed(2)} km | {activity.duration} | FC Moy: {activity.avgHeartRate} BPM
                                            </p>
                                        </div>
                                    </div>
                                    <span className="text-blue-500 font-medium text-sm mt-2 sm:mt-0 sm:ml-4 flex-shrink-0">V. Max: {activity.maxSpeed.toFixed(1)} km/h</span>
                                </li>
                            ))
                        )}
                    </ul>
                </div>
            );
            
            // Rendu final
            ReactDOM.render(<App />, document.getElementById('root'));
        }; // FIN du window.onload
    </script>
</body>
</html>
